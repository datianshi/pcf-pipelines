# Copyright 2017-Present Pivotal Software, Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

resource_types:
- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

resources:
- name: pcf-pipelines
  type: git
  source:
    uri: git@github.com:datianshi/pcf-pipelines.git
    branch: restore-pcf
    private_key: {{git_private_key}}

- name: pivnet-opsmgr
  type: pivnet
  source:
    api_token: {{pivnet_token}}
    product_slug: ops-manager
    product_version: {{opsman_major_minor_version}}
    sort_by: semver

- name: opsmgr-settings
  type: s3
  source:
    bucket: ((backup-artifact-bucket))
    region_name: ((storage-region))
    endpoint: ((storage-endpoint))
    access_key_id: ((storage-access-key-id))
    secret_access_key: ((storage-secret-access-key))
    versioned_file: installation.zip

# - name: ert-backup-bucket
#   type: s3
#   source:
#     bucket: ((backup-artifact-bucket))
#     region_name: ((storage-region))
#     endpoint: ((storage-endpoint))
#     access_key_id: ((storage-access-key-id))
#     secret_access_key: ((storage-secret-access-key))
#     versioned_file: ert-backup.tar

- name: director-backup-bucket
  type: s3
  source:
    bucket: ((backup-artifact-bucket))
    region_name: ((storage-region))
    endpoint: ((storage-endpoint))
    access_key_id: ((storage-access-key-id))
    secret_access_key: ((storage-secret-access-key))
    versioned_file: director-backup.tar

- name: bbr-release
  type: pivnet
  source:
    api_token: ((pivnet_token))
    product_slug: p-bosh-backup-and-restore
    product_version: ((bbr-version))




- name: schedule
  type: time
  source:
    interval: 30m
    start: "12:00 AM"
    stop: "11:59 PM"
    location: America/Los_Angeles
    days: [Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday]

jobs:
- name: regulator
  plan:
  - get: schedule
    trigger: true
  - get: pivnet-opsmgr
    params: { globs: [] }

- name: install-opsmgr
  plan:
  - aggregate:
    - get: pivnet-opsmgr
      passed: [regulator]
      params:
        globs: ["*.ova"]
    - get: pcf-pipelines
    - get: opsmgr-settings

  - task: deploy-opsman-vm
    file: pcf-pipelines/tasks/deploy-opsman-vm0/task.yml
    params:
      OPSMAN_TIMEOUT: {{opsman_timeout_seconds}}
      GOVC_USERNAME: {{vcenter_username}}
      GOVC_PASSWORD: {{vcenter_password}}
      GOVC_DATACENTER: {{vcenter_datacenter}}
      GOVC_CLUSTER: {{vcenter_cluster}}
      GOVC_RESOURCE_POOL: {{vcenter_resource_pool}}
      GOVC_DATASTORE: {{vcenter_datastore}}
      GOVC_INSECURE: {{vcenter_insecure}}
      GOVC_CA_CERT: {{vcenter_ca_cert}}
      GOVC_URL: {{vcenter_url}}
      OPSMAN_IP: {{opsman_ip}}
      OPSMAN_DOMAIN_OR_IP_ADDRESS: {{opsman_domain_or_ip_address}}
      NETMASK: {{netmask}}
      GATEWAY: {{gateway}}
      DNS: {{dns}}
      NTP: {{ntp}}
      OPSMAN_NETWORK: {{opsman_network}}
      OPSMAN_VM_FOLDER: {{om_vm_folder}}
      OPSMAN_SSH_PASSWORD: {{opsman_ssh_password}}
      OPSMAN_DISK_TYPE: {{opsman_disk_type}}

  - task: import-opsmgr
    file: pcf-pipelines/tasks/import-opsmgr-settings/task.yml
    params:
      OPSMAN_CLIENT_ID: {{opsman_client_id}}
      OPSMAN_CLIENT_SECRET: {{opsman_client_secret}}
      OPSMAN_USERNAME: {{opsman_admin_username}}
      OPSMAN_PASSWORD: {{opsman_admin_password}}
      OPSMAN_PASSPHRASE: {{opsman_passphrase}}
      OPSMAN_DOMAIN_OR_IP_ADDRESS: {{opsman_domain_or_ip_address}}
      OPSMAN_SETTINGS_FILENAME: installation.zip

- name: deploy-bosh-only
  plan:
  - aggregate:
    - get: pcf-pipelines
  - task: apply-changes
    file: pcf-pipelines/tasks/apply-changes-director-only/task.yml
    params:
      OPSMAN_CLIENT_ID: {{opsman_client_id}}
      OPSMAN_CLIENT_SECRET: {{opsman_client_secret}}
      OPSMAN_USERNAME: {{opsman_admin_username}}
      OPSMAN_PASSWORD: {{opsman_admin_password}}
      OPSMAN_DOMAIN_OR_IP_ADDRESS: {{opsman_domain_or_ip_address}}

- name: restore-bosh
  plan:
  - aggregate:
    - get: pcf-pipelines
    - get: director-backup-bucket
    - get: bbr-release

  - aggregate:
    - task: extract-binary
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: cloudfoundrylondon/bbr-pipeline
            tag: release-candidate
        inputs:
        - name: bbr-release
        outputs:
        - name: binary
        run:
          path: sh
          args:
          - -c
          - |
            tar -xvf bbr-release/bbr*.tar
            cp releases/bbr binary/

    - task: extract-archive
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: cloudfoundrylondon/bbr-pipeline
            tag: release-candidate
        inputs:
        - name: director-backup-bucket
        outputs:
        - name: archive
        run:
          path: sh
          args:
          - -c
          - |
            tar -xvf director-backup-bucket/director-backup.tar --strip 1 -C archive

  - task: bbr-restore-director
    tags:
    file: pcf-pipelines/tasks/bbr-restore-director/task.yml
    params:
      SKIP_SSL_VALIDATION: ((skip-ssl-validation))
      OPSMAN_URL: "https://((opsman_domain_or_ip_address))"
      OPSMAN_USERNAME: ((opsman_admin_username))
      OPSMAN_PASSWORD: ((opsman_admin_password))

- name: apply-changes
  plan:
  - aggregate:
    - get: pcf-pipelines
      passed: [restore-bosh]
  - task: apply-changes
    file: pcf-pipelines/tasks/apply-changes/task.yml
    params:
      OPSMAN_CLIENT_ID: {{opsman_client_id}}
      OPSMAN_CLIENT_SECRET: {{opsman_client_secret}}
      OPSMAN_USERNAME: {{opsman_admin_username}}
      OPSMAN_PASSWORD: {{opsman_admin_password}}
      OPSMAN_DOMAIN_OR_IP_ADDRESS: {{opsman_domain_or_ip_address}}
